---
title: "Projekt analityczny"
author: "Weronika Bola"
date: "12 czerwca 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Opis danych
Analizowane dane dotycz¹ opóŸnieñ po³¹czeñ lotniczych w USA w lipcu 2017 r.

Liczba zawartych tabel w bazie danych wynosi 4. Przedstawione s¹ w nich informacje o nazwach linii lotniczych, nazwach lotnisk, opóŸnieniach lotów, pogodzie i dniach tygodnia.

Dane zawarte w atrybutach tych tabel, które s¹ brane pod uwagê, odnosz¹ siê do: opóŸnieñ przylotów i wylotów w minutach, informacji o przewoŸnikach, z których korzystaj¹ pasa¿erowie, zarówno miastach wylotów, jak i przylotów, nazw lotów oraz dat poszczególnych lotów wraz z dniami tygodnia, w których by³y wykonywane.

## Po³¹czenie
```{r}
library(odbc)
con <- DBI::dbConnect(odbc(),
                      Driver   = "SQL Server",
                      Server   = "mssql-2016.labs.wmi.amu.edu.pl",
                      Database = "dbad_flights",
                      Port     = 1433)
```


## Pytanie 1.
Jakie by³o œrednie opóŸnienie przylotu?

```{r}
dbGetQuery(con, "SELECT AVG(arr_delay) [œrednie_opóŸnienie_przylotu] 
                 FROM Flight_delays")
```

## Pytanie 2.
Jakie by³o maksymalne opóŸnienie przylotu?

```{r}
dbGetQuery(con, "SELECT MAX(arr_delay) [maksymalne_opóŸnienie_przylotu] 
                 FROM Flight_delays")
```

## Pytanie 3.
Który lot mia³ najwiêksze opóŸnienie przylotu?

[przewoŸnik, miasto wylotu, miasto przylotu, data lotu, opóŸnienie]

```{r}
dbGetQuery(con, "SELECT arr_delay [opóŸnienie], 
                        carrier [przewoŸnik],
                        origin_city_name [miasto_wylotu],
                        dest_city_name [miasto_przylotu], 
                        fl_date [data_lotu]
                 FROM Flight_delays 
                 WHERE arr_delay = (SELECT MAX(arr_delay) 
                                    FROM Flight_delays)")
```

## Pytanie 4.
Które dni tygodnia s¹ najgorsze do podró¿owania?

[tabela zawieraj¹ca dla ka¿dego dnia tygodnia œredni czas opóŸnienia]

```{r}
dbGetQuery(con, "SELECT CAST(w.weekday_name AS VARCHAR(20)) [dzieñ_tygodnia], 
                        AVG(f.arr_delay) [œredni_czas_opóŸnienia] 
                 FROM Flight_delays f 
                      JOIN Weekdays w
                        ON f.day_of_week=w.weekday_id
                 GROUP BY CAST(w.weekday_name AS VARCHAR(20)) 
                 ORDER BY [œredni_czas_opóŸnienia] DESC")
```

## Pytanie 5.
Które linie lotnicze lataj¹ce z San Francisco (SFO) maj¹ najmniejsze opóŸnienia przylotu?

[tabela zawieraj¹ca nazwê przewoŸnika oraz œrednie opóŸnienie z jego wszystkich lotów]

```{r}
dbGetQuery(con, "SELECT *
                 FROM
                 (
                    SELECT AVG(dep_delay+arr_delay) AS [œrednie_opóŸnienie], 
                           CAST(carrier AS VARCHAR(100)) AS [przewoŸnik]
                    FROM Flight_delays 
                    WHERE origin LIKE 'SFO'
                    GROUP BY CAST(carrier AS VARCHAR(100))
                 ) t
                 WHERE [œrednie_opóŸnienie] <= ALL 
                 (
                    SELECT AVG(dep_delay+arr_delay) AS [œrednie_opóŸnienie]
                    FROM Flight_delays 
                    WHERE origin LIKE 'SFO'
                    GROUP BY CAST(carrier AS VARCHAR(100))
                 )")
```

## Pytanie 6.
Jaka czêœæ linii lotniczych ma regularne opóŸnienia, tj. jej lot ma œrednio co najmniej 10 min. opóŸnienia?

[tylko linie lotnicze wystêpuj¹ce w tabeli Flight_delays]

```{r} 
x <- dbGetQuery(con, "SELECT * 
                      FROM 
                      (
                         SELECT AVG(arr_delay) AS [opóŸnienie], 
                         CAST(carrier AS VARCHAR(100)) AS [linia_lotnicza] 
                         FROM Flight_delays
                         GROUP BY CAST(carrier AS VARCHAR(100))
                      ) AS t 
                      WHERE opóŸnienie >= 10")
y <- dbGetQuery(con, "SELECT DISTINCT CAST(carrier AS varchar(100)) 
                      FROM Flight_delays")
(wynik <- nrow(x)/nrow(y))
```

## Pytanie 7.
Jak opóŸnienia wylotów wp³ywaj¹ na opóŸnienia przylotów?

[wspó³czynnik korelacji Pearsona miêdzy czasem opóŸnienia wylotów a czasem opóŸnienia przylotów]

```{r}
w <- dbGetQuery(con, "SELECT dep_delay [czas_opóŸnienia_wylotów] 
                      FROM Flight_delays")
p <- dbGetQuery(con, "SELECT arr_delay [czas_opóŸnienia_przylotów] 
                      FROM Flight_delays")
w <- w[,1]
p <- p[,1]
w[is.na(w)] <- 0
p[is.na(p)] <- 0
cor(w, p)
```

## Pytanie 8.
Która linia lotnicza mia³a najwiêkszy wzrost (w wartoœciach bezwzglêdnych) œredniego opóŸnienia przylotów w ostatnim tygodniu miesi¹ca, tj. miêdzy 1-23 a 24-31 lipca?

[nazwa przewoŸnika oraz wzrost]

```{r}
a <- dbGetQuery(con, "SELECT AVG(f.arr_delay) [œrednie_opóŸnienie_przylotóW], 
                             RIGHT(CAST(a.airline_name AS VARCHAR(100)),2) 
                      FROM Flight_delays f
                           JOIN Airlines a 
                             ON a.airline_id=f.airline_id
                      WHERE (MONTH(CAST(f.fl_date AS VARCHAR(100)))=7) 
                             AND (DAY(CAST(f.fl_date AS VARCHAR(100))) BETWEEN 01 AND 23) 
                      GROUP BY CAST(a.airline_name AS VARCHAR(100)) 
                      ORDER BY CAST(a.airline_name AS VARCHAR(100))")
b <- dbGetQuery(con, "SELECT AVG(f.arr_delay) [œrednie_opóŸnienie_przylotóW], 
                             RIGHT(CAST(a.airline_name AS VARCHAR(100)),2) 
                      FROM Flight_delays f
                           JOIN Airlines a 
                             ON a.airline_id=f.airline_id
                      WHERE (MONTH(CAST(f.fl_date AS VARCHAR(100)))=7) 
                             AND (DAY(CAST(f.fl_date AS VARCHAR(100))) BETWEEN 24 AND 31) 
                      GROUP BY CAST(a.airline_name AS VARCHAR(100)) 
                      ORDER BY CAST(a.airline_name AS VARCHAR(100))")
c=data.frame(przewoznik=a[,2],wzrost=abs(a[,1]-b[,1]))
c[which.max(c[,2]),]

```
## Pytanie 9.
Które linie lotnicze lataj¹ zarówno na trasie SFO -› PDX (Portland), jak i SFO -› EUG (Eugene)?

```{r}
dbGetQuery(con, "SELECT airline_name [linia_lotnicza]
                 FROM Airlines 
                 WHERE airline_id IN (
                                        SELECT airline_id 
                                        FROM Flight_delays
                                        WHERE (origin LIKE 'SFO' AND dest LIKE 'PDX')
                                     ) 
                 AND airline_id IN (
                                      SELECT airline_id 
                                      FROM Flight_delays
                                      WHERE (origin LIKE 'SFO' AND dest LIKE 'EUG')
                                   )")
```

## Pytanie 10.
Jak najszybciej dostaæ siê z Chicago do Stanfordu, zak³adaj¹c wylot po 14:00 czasu lokalnego?

[tabela zawieraj¹ca jako miejsce wylotu Midway (MDW) lub O'Hare (ORD), jako miejsce przylotu San Francisco (SFO), San Jose (SJC) lub Oakland (OAK) oraz œredni czas opóŸnienia przylotu dla wylotów po 14:00 czasu lokalnego (atrybut crs_dep_time); wyniki pogrupowane po miejscu wylotu i przylotu, posortowane malej¹co]

```{r}
dbGetQuery(con, "SELECT AVG(arr_delay) [œredni_czas], 
                        CAST(origin AS VARCHAR(8)) [miejsce_wylotu], 
                        CAST(dest AS VARCHAR(8)) [miejsce_przylotu]
                 FROM Flight_delays 
                 WHERE (CAST(origin AS VARCHAR(100)) IN ('MDW','ORD')) 
                        AND (CAST(dest AS VARCHAR(100)) IN ('SFO', 'SJC', 'OAK')) 
                        AND (LEN(CAST(crs_dep_time AS VARCHAR(5)))=4) 
                        AND (CAST(LEFT(CAST(crs_dep_time AS VARCHAR(5)),2) AS INT)>=14)
                 GROUP BY CAST(origin AS VARCHAR(8)), CAST(dest AS VARCHAR(8))
                 ORDER BY œredni_czas")
```

## Podsumowanie

Z przedstawionych danych wynika, ¿e œrednie opóŸnienie przylotu wynosi³o 8.31161, a maksymalne by³o równe 1895. 

Najwiêksze opóŸnienie przylotu mia³ lot, w którym przewoŸnikiem by³y amerykañskie linie lotnicze, miastem wylotu byla Kona, natomiast przylotu Los Angeles. Lot odby³ siê 26 lipca. 

Najgorszymi dniami do podró¿owania by³y w kolejnoœci: pi¹tek, poniedzia³ek, czwartek, œroda, sobota, wtorek, niedziela. 

Liniami lotniczymi lataj¹cymi z San Francisco, które mia³y najmniejsze opóŸnienia przylotu by³y Hawaiian Airlines Inc. 

1/3 linii lotniczych mia³a regularne opóŸnienia, tj. ich lot mia³ œrednio co najmniej 10 min. opóŸnienia. 

OpóŸnienia wylotów mia³y du¿y wp³yw na opóŸnienia przylotów, wraz z ich wzrostem powiêksza³y siê opóŸnienia przylotów.

Najwiêkszy wzrost œredniego opóŸnienia przylotów w ostatnim tygodniu miesi¹ca, tj. miêdzy 1-23 a 24-31 lipca mia³a linia lotnicza ExpressJet Airlines Inc.

Liniami lotniczymi, które lata³y zarówno na trasie San Francisco -> Portland, jak i San Francisco -> Eugene by³y United Air Lines Inc. i SkyWest Airlines Inc.

Z Chicago do Stanfordu zak³adaj¹c wylot po 14:00 czasu lokalnego najszybciej dostaæ siê wylatuj¹c z O'Hare, a przylatuj¹c do Oakland.